/** This  function activates when the Create Event Panel's Submit Button is Pressed
 * The function takes all the values of the Panel's Form inputs and writes the data as a unique event string.
 * The String is generated by a random string function.
 * 
 * @author Kibum Park
 * @version 3.0
*/

//Variables for firebase.
var firebase = app_firebase;  
var dB = firebase.database();
var authRef = firebase.auth();

authRef.onAuthStateChanged(function(user) {
  /**Function to create Random String
   * @param length Sets how long the Random String is.
   * @returns The newly Random String.
   */
  function makeid(length) {
    var result = '';
    var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    var charactersLength = characters.length;
    for ( var i = 0; i < length; i++ ) {
      result += characters.charAt(Math.floor(Math.random() * charactersLength));
    }
    return result;
  }

  //Function to take Form Data
  $("#forms").submit(function(event) {
      var arraylist = {}
      arraylist = $(this).serializeArray()
      event.preventDefault();

      //Variable to get the selected day from datepicker.js 
      var dateObject = $('#datepicker').datepicker({ dateFormat: 'dd-mm-yy' }).val();
      //Array with the day, month, and year values.
      var pieces = dateObject.toString().split(' ');

      //Generate Random String for Key
      var str = makeid(10)
    
      //Creates new event data key (with Random String) under the current user's "eventsCreated" node
      dB.ref('users/' + user.uid + '/eventsCreated').once('value', function(snapshot) {
        //Creates a number key for the event 
        var childnum = snapshot.numChildren(); 
        dB.ref('users/' + user.uid + '/eventsCreated').update({
          [childnum + 1] : str
        })
      }); 
       
      //Create a key for the Random String with the event details under the "events" node
      dB.ref('events/' + str).set({
        day: pieces[0],
        month: pieces[1],
        year: pieces[2],
        eventname: arraylist[0].value,
        eventStartTime: arraylist[1].value,
        eventEndTime: arraylist[2].value,
        eventLocation: arraylist[3].value,
        eventDetails: arraylist[4].value
      })  
      $('.eventpanel').addClass('mobileDisplay');
      document.getElementById("forms").reset();
  })
});
